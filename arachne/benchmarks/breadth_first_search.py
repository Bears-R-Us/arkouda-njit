"""Breadth-First Search Benchmark

This script provides a benchmark on a graph built in Arachne from two Arkouda arrays. The graphs are 
randomly generated by using the ak.randint function with the range of the vertex names being picked 
from [0,n-1] and the number of edges m. No special distribution is used to generate the graph. 
Select seed value to ensure repeatability of experiments.

The values of n and m are accepted from command line input. As well as the number of trials for
executing breadth-first search.

Assumes Arkouda server is running. It will shutdown the Arkouda server upon completion.
"""
import argparse
import os
import time
import statistics as st
import arachne as ar
import arkouda as ak

def create_parser():
    """Creates the command line parser for this script"""
    parser = argparse.ArgumentParser(
        description="Simple benchmark for breadth-first search on randomly generated sample graphs."
    )
    parser.add_argument("hostname", help = "Hostname of the arkouda server")
    parser.add_argument("port", type = int, default = 5555,
                        help = "Port used by the arkouda server")

    parser.add_argument("--rand", type = bool, default = True, help = "Run random benchmark?")
    parser.add_argument("-n", type = int, default = 1000, help = "Number of vertices for graph")
    parser.add_argument("-m", type = int, default = 2000, help = "Number of edges for graph")

    parser.add_argument("--mtx", type = bool, default = True, help = "Run mtx benchmark?")
    parser.add_argument("--filepath", type = str, default = "../data/karate.mtx",
                        help = ".mtx file to benchmark")
    parser.add_argument("--directed", type = bool, default = False, help = "Is graph directed?")

    parser.add_argument("-t", "--trials", type = int, default = 5,
                        help = " Number of trials for BFS"
                        )

    return parser

def run_rand_benchmark(args):
    """Runs rand benchmark and prints out results to terminal."""
    ### Build graph from randomly generated source and destination arrays.
    # 1. Use Arkouda's randint to generate the random edge arrays.
    src = ak.randint(0, args.n, args.m)
    dst = ak.randint(0, args.n, args.m)

    # 2. Build undirected graph.
    print("### Arachne Graph Building")
    start = time.time()
    graph = ar.Graph()
    graph.add_edges_from(src, dst)
    end = time.time()
    print(f"Building undirected graph with {len(graph)} vertices and {graph.size()} edges "
          f"took {round(end-start,2)} seconds")

    # 3. Build directed graph.
    start = time.time()
    di_graph = ar.DiGraph()
    di_graph.add_edges_from(src, dst)
    end = time.time()
    print(f"Building directed graph with {len(di_graph)} vertices and {di_graph.size()} "
          f"edges took {round(end-start,2)} seconds")
    print()

    print("### Arachne Breadth-First Search")
    ### Run Arachne breadth-first search on the input graphs.
    # 1. BFS on undirected graph.
    undirected_bfs_trials = []
    highest_degree = ak.argmax(graph.degree())
    for _ in range(args.trials):
        start = time.time()
        _ = ar.bfs_layers(graph, int(graph.nodes()[highest_degree]))
        end = time.time()
        undirected_bfs_trials.append(end-start)
    avg_runtime_undirected = round(st.mean(undirected_bfs_trials),2)
    print(f"Running breadth-first search on undirected graph took on average "
          f"{avg_runtime_undirected} seconds")

    # 2. BFS on directed graph.
    directed_bfs_trials = []
    highest_out_degree = ak.argmax(di_graph.out_degree())
    for _ in range(args.trials):
        start = time.time()
        _ = ar.bfs_layers(di_graph, int(di_graph.nodes()[highest_out_degree]))
        end = time.time()
        directed_bfs_trials.append(end-start)
    avg_runtime_directed = round(st.mean(directed_bfs_trials),2)
    print(f"Running breadth-first search on directed graph took on average {avg_runtime_directed} "
          f"seconds")
    print()

    # 3. Print out times in comma-delimited manner.
    print("### Full Timings")
    undirected_bfs_trials = [round(x,2) for x in undirected_bfs_trials]
    directed_bfs_trials = [round(x,2) for x in directed_bfs_trials]
    print(f"undirected_bfs_trials = {undirected_bfs_trials}")
    print(f"directed_bfs_trials   = {directed_bfs_trials}")

def run_mtx_benchmark(args):
    """Runs mtx benchmark and prints out results to terminal."""
    ### Build graph from matrix market file.
    # 1. Use Arachne's matrix_market reading method.
    print("### Arachne Graph Building")
    start = time.time()
    graph = ar.read_matrix_market_file(os.path.abspath(args.filepath), args.directed)
    end = time.time()
    graph_type = "directed" if args.directed else "undirected"
    print(f"Building {graph_type} graph with {len(graph)} vertices and {graph.size()} edges took "
          f"{round(end-start,2)} seconds")

    print()
    print("### Arachne Breadth-First Search")
    ### Run Arachne breadth-first search on the input graph.
    bfs_trials = []
    highest_degree = ak.argmax(graph.degree())
    for _ in range(args.trials):
        start = time.time()
        _ = ar.bfs_layers(graph, int(graph.nodes()[highest_degree]))
        end = time.time()
        bfs_trials.append(end-start)
    avg_runtime = round(st.mean(bfs_trials),2)
    print(f"Running breadth-first search on {graph_type} graph took on average "
          f"{avg_runtime} seconds")

    # 3. Print out times in comma-delimited manner.
    print("### Full Timings")
    bfs_trials = [round(x,2) for x in bfs_trials]
    print(f"bfs_trials = {bfs_trials}")

if __name__ == "__main__":
    # Command line parser and extraction.
    benchmark_parser = create_parser()
    in_args = benchmark_parser.parse_args()

    # Connect to the Arkouda server.
    ak.verbose = False
    ak.connect(in_args.hostname, in_args.port)

    if in_args.rand:
        print("\n##### RAND BENCHMARK")
        run_rand_benchmark(in_args)

    if in_args.mtx:
        filename = in_args.filepath.split("/")[-1]
        print(f"\n##### MTX BENCHMARK FOR GRAPH {filename}")
        run_mtx_benchmark(in_args)

    if not in_args.rand and not in_args.mtx:
        print("Unrecognized benchmark type. Terminating.")

    ak.shutdown()
